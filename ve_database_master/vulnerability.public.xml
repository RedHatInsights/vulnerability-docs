<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<database name="vulnerability" schema="public" type="PostgreSQL - 12.1">
   <sequences>
      <sequence increment="1" name="cve_metadata_id_seq" startValue="1"/>
      <sequence increment="1" name="db_upgrade_log_id_seq" startValue="1"/>
      <sequence increment="1" name="insights_rule_id_seq" startValue="1"/>
      <sequence increment="1" name="playbook_id_seq" startValue="1"/>
      <sequence increment="1" name="repo_id_seq" startValue="1"/>
      <sequence increment="1" name="rh_account_id_seq" startValue="1"/>
      <sequence increment="1" name="system_platform_id_seq" startValue="1"/>
      <sequence increment="1" name="system_vulnerabilities_id_seq" startValue="1"/>
   </sequences>
   <tables>
      <table name="business_risk" numRows="4" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <child column="business_risk_id" foreignKey="business_risk_id" implied="false" onDeleteCascade="false" schema="public" table="cve_account_data"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="" size="2147483647" type="varchar" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="business_risk_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="business_risk_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty((name)::text)))" name="business_risk_name_check"/>
      </table>
      <table name="cve_account_data" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="cve_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="cve_id" implied="false" onDeleteCascade="false" schema="public" table="cve_metadata"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="rh_account_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="rh_account_id" implied="false" onDeleteCascade="false" schema="public" table="rh_account"/>
         </column>
         <column autoUpdated="false" defaultValue="0" digits="0" id="2" name="business_risk_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="business_risk_id" implied="false" onDeleteCascade="false" schema="public" table="business_risk"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="business_risk_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="4" name="status_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="status_id" implied="false" onDeleteCascade="false" schema="public" table="status"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="status_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="6" name="systems_affected" nullable="false" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="7" name="systems_status_divergent" nullable="false" remarks="" size="10" type="int4" typeCode="4"/>
         <index name="cve_account_data_cve_id_rh_account_id_key" unique="true">
            <column ascending="true" name="cve_id"/>
            <column ascending="true" name="rh_account_id"/>
         </index>
      </table>
      <table name="cve_impact" numRows="8" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <child column="impact_id" foreignKey="impact_id" implied="false" onDeleteCascade="false" schema="public" table="cve_metadata"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="cve_impact_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="cve_impact_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty(name)))" name="cve_impact_name_check"/>
      </table>
      <table name="cve_metadata" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('cve_metadata_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4">
            <child column="cve_id" foreignKey="cve_id" implied="false" onDeleteCascade="false" schema="public" table="cve_account_data"/>
            <child column="cve_id" foreignKey="cve_id" implied="false" onDeleteCascade="false" schema="public" table="cve_rule_mapping"/>
            <child column="cve_id" foreignKey="cve_metadata_cve_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_active"/>
            <child column="cve_id" foreignKey="cve_metadata_cve_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_inactive"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="cve" nullable="false" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="description" nullable="false" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="impact_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="impact_id" implied="false" onDeleteCascade="false" schema="public" table="cve_impact"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="6" id="4" name="public_date" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="5" name="modified_date" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="3" id="6" name="cvss3_score" nullable="true" remarks="" size="5" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="cvss3_metrics" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="3" id="8" name="cvss2_score" nullable="true" remarks="" size="5" type="numeric" typeCode="2"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="cvss2_metrics" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="10" name="redhat_url" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="11" name="secondary_url" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="12" name="advisories_list" nullable="true" remarks="" size="2147483647" type="jsonb" typeCode="1111"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="cve_metadata_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="cve_metadata_cve_key" unique="true">
            <column ascending="true" name="cve"/>
         </index>
         <index name="cve_metadata_cvss2_score_idx" unique="false">
            <column ascending="true" name="cvss2_score"/>
         </index>
         <index name="cve_metadata_cvss3_score_idx" unique="false">
            <column ascending="true" name="cvss3_score"/>
         </index>
         <index name="cve_metadata_impact_id_idx" unique="false">
            <column ascending="true" name="impact_id"/>
         </index>
         <checkConstraint constraint="((NOT empty(cve)))" name="cve_metadata_cve_check"/>
         <checkConstraint constraint="((NOT empty(description)))" name="cve_metadata_description_check"/>
      </table>
      <table name="cve_rule_mapping" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="cve_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="cve_id" implied="false" onDeleteCascade="false" schema="public" table="cve_metadata"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="rule_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="insights_rule"/>
         </column>
         <index name="cve_rule_mapping_cve_id_rule_id_key" unique="true">
            <column ascending="true" name="cve_id"/>
            <column ascending="true" name="rule_id"/>
         </index>
      </table>
      <table name="db_upgrade_log" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('db_upgrade_log_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="version" nullable="false" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="status" nullable="false" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="script" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="returncode" nullable="true" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="stdout" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="stderr" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="7" name="last_updated" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <index name="db_upgrade_log_version_idx" unique="false">
            <column ascending="true" name="version"/>
         </index>
      </table>
      <table name="db_version" numRows="1" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="business_risk"/>
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="cve_impact"/>
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="insights_rule"/>
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="repo"/>
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="rh_account"/>
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="status"/>
            <child column="display_name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="system_platform"/>
            <child column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="timestamp_kv"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="version" nullable="false" remarks="" size="10" type="int4" typeCode="4"/>
         <primaryKey column="name" sequenceNumberInPK="1"/>
         <index name="db_version_pkey" unique="true">
            <column ascending="true" name="name"/>
         </index>
      </table>
      <table name="insights_rule" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('insights_rule_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4">
            <child column="rule_id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="cve_rule_mapping"/>
            <child column="rule_id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="playbook"/>
            <child column="rule_id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_active"/>
            <child column="rule_id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_inactive"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="description_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="summary_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="generic_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="reason_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="resolution_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="more_info_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="8" name="reboot_required" nullable="true" remarks="" size="1" type="bool" typeCode="-7"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="playbook_count" nullable="true" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="10" name="change_risk" nullable="true" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="11" name="kbase_node_id" nullable="true" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="false" digits="0" id="12" name="active" nullable="false" remarks="" size="1" type="bool" typeCode="-7"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="insights_rule_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="insights_rule_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty(name)))" name="insights_rule_name_check"/>
      </table>
      <table name="playbook" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('playbook_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="rule_id" nullable="true" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="insights_rule"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="play" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="version" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="description" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="playbook_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="repo" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('repo_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4">
            <child column="repo_id" foreignKey="repo_id" implied="false" onDeleteCascade="false" schema="public" table="system_repo"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="repo_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="repo_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty(name)))" name="repo_name_check"/>
      </table>
      <table name="rh_account" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('rh_account_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4">
            <child column="rh_account_id" foreignKey="rh_account_id" implied="false" onDeleteCascade="false" schema="public" table="cve_account_data"/>
            <child column="rh_account_id" foreignKey="rh_account_id" implied="false" onDeleteCascade="false" schema="public" table="system_platform"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="rh_account_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="rh_account_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty(name)))" name="rh_account_name_check"/>
      </table>
      <table name="status" numRows="7" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <child column="status_id" foreignKey="status_id" implied="false" onDeleteCascade="false" schema="public" table="cve_account_data"/>
            <child column="status_id" foreignKey="status_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_active"/>
            <child column="status_id" foreignKey="status_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_inactive"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="status_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="status_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty(name)))" name="status_name_check"/>
      </table>
      <table name="system_platform" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('system_platform_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4">
            <child column="system_id" foreignKey="system_platform_id" implied="false" onDeleteCascade="false" schema="public" table="system_repo"/>
            <child column="system_id" foreignKey="system_platform_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_active"/>
            <child column="system_id" foreignKey="system_platform_id" implied="false" onDeleteCascade="false" schema="public" table="system_vulnerabilities_inactive"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="inventory_id" nullable="false" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="display_name" nullable="true" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="rh_account_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="rh_account_id" implied="false" onDeleteCascade="false" schema="public" table="rh_account"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="6" id="4" name="first_reported" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="s3_url" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="vmaas_json" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="json_checksum" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="8" name="last_updated" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="9" name="unchanged_since" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="10" name="last_evaluation" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="11" name="advisor_evaluated" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="false" digits="0" id="12" name="opt_out" nullable="false" remarks="" size="1" type="bool" typeCode="-7"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="13" name="cve_count_cache" nullable="false" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="14" name="last_upload" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="15" name="stale_timestamp" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="16" name="stale_warning_timestamp" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="17" name="culled_timestamp" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="false" digits="0" id="18" name="stale" nullable="false" remarks="" size="1" type="bool" typeCode="-7"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="19" name="when_deleted" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="system_platform_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="system_platform_inventory_id_key" unique="true">
            <column ascending="true" name="inventory_id"/>
         </index>
         <index name="system_platform_rh_account_id_idx" unique="false">
            <column ascending="true" name="rh_account_id"/>
         </index>
         <index name="system_platform_stale_idx" unique="false">
            <column ascending="true" name="stale"/>
         </index>
         <index name="system_platform_stale_warning_timestamp_idx" unique="false">
            <column ascending="true" name="stale_warning_timestamp"/>
         </index>
         <index name="system_platform_when_deleted_idx" unique="false">
            <column ascending="true" name="when_deleted"/>
         </index>
         <checkConstraint constraint="((NOT empty(inventory_id)))" name="system_platform_inventory_id_check"/>
      </table>
      <table name="system_repo" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="system_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="system_platform_id" implied="false" onDeleteCascade="false" schema="public" table="system_platform"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="repo_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="repo_id" implied="false" onDeleteCascade="false" schema="public" table="repo"/>
         </column>
         <index name="system_repo_repo_id_idx" unique="false">
            <column ascending="true" name="repo_id"/>
         </index>
         <index name="system_repo_system_id_idx" unique="false">
            <column ascending="true" name="system_id"/>
         </index>
         <index name="system_repo_system_id_repo_id_key" unique="true">
            <column ascending="true" name="system_id"/>
            <column ascending="true" name="repo_id"/>
         </index>
      </table>
      <table name="system_vulnerabilities_active" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('system_vulnerabilities_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="system_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="system_platform_id" implied="false" onDeleteCascade="false" schema="public" table="system_platform"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="cve_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="cve_metadata_cve_id" implied="false" onDeleteCascade="false" schema="public" table="cve_metadata"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="rule_id" nullable="true" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="insights_rule"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="rule_hit_details" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="mitigation_reason" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="6" name="first_reported" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="7" name="when_mitigated" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="8" name="status_id" nullable="true" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="status_id" implied="false" onDeleteCascade="false" schema="public" table="status"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="status_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="system_vulnerabilities_active_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="system_vulnerabilities_active_status_id_idx" unique="false">
            <column ascending="true" name="status_id"/>
         </index>
         <index name="system_vulnerabilities_active_system_id_cve_id_key" unique="true">
            <column ascending="true" name="system_id"/>
            <column ascending="true" name="cve_id"/>
         </index>
      </table>
      <table name="system_vulnerabilities_inactive" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('system_vulnerabilities_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="system_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="system_platform_id" implied="false" onDeleteCascade="false" schema="public" table="system_platform"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="cve_id" nullable="false" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="cve_metadata_cve_id" implied="false" onDeleteCascade="false" schema="public" table="cve_metadata"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="rule_id" nullable="true" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="rule_id" implied="false" onDeleteCascade="false" schema="public" table="insights_rule"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="rule_hit_details" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="mitigation_reason" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="6" name="first_reported" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="6" id="7" name="when_mitigated" nullable="true" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <column autoUpdated="false" defaultValue="0" digits="0" id="8" name="status_id" nullable="true" remarks="" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="status_id" implied="false" onDeleteCascade="false" schema="public" table="status"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="status_text" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="system_vulnerabilities_inactive_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="system_vulnerabilities_inactive_status_id_idx" unique="false">
            <column ascending="true" name="status_id"/>
         </index>
         <index name="system_vulnerabilities_inactive_system_id_cve_id_key" unique="true">
            <column ascending="true" name="system_id"/>
            <column ascending="true" name="cve_id"/>
         </index>
      </table>
      <table name="timestamp_kv" numRows="0" remarks="" schema="public" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="name" nullable="false" remarks="" size="2147483647" type="text" typeCode="12">
            <parent column="name" foreignKey="Implied Constraint" implied="true" onDeleteCascade="false" schema="public" table="db_version"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="6" id="1" name="value" nullable="false" remarks="" size="35" type="timestamptz" typeCode="93"/>
         <index name="timestamp_kv_name_key" unique="true">
            <column ascending="true" name="name"/>
         </index>
         <checkConstraint constraint="((NOT empty(name)))" name="timestamp_kv_name_check"/>
      </table>
   </tables>
   <routines>
      <routine dataAccess="MODIFIES" deterministic="false" name="check_unchanged" returnType="trigger" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    IF (TG_OP = 'INSERT') AND
       NEW.unchanged_since IS NULL THEN
      NEW.unchanged_since := CURRENT_TIMESTAMP;
    END IF;
    IF (TG_OP = 'UPDATE') AND
       NEW.json_checksum <> OLD.json_checksum THEN
      NEW.unchanged_since := CURRENT_TIMESTAMP;
    END IF;
    RETURN NEW;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="delete_system" returnType="SETOF text" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    -- opt out to refresh cache and then delete
    WITH locked_row AS (
      SELECT id
      FROM system_platform
      WHERE inventory_id = inventory_id_in
      FOR UPDATE
    )
    UPDATE system_platform SET opt_out = true
    WHERE inventory_id = inventory_id_in;
    DELETE FROM system_vulnerabilities
    WHERE system_id = (SELECT id from system_platform WHERE inventory_id = inventory_id_in);
    DELETE FROM system_repo
    WHERE system_id = (SELECT id from system_platform WHERE inventory_id = inventory_id_in);
    RETURN QUERY DELETE FROM system_platform
    WHERE inventory_id = inventory_id_in
    RETURNING inventory_id;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="empty" returnType="boolean" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    RETURN t ~ '^[[:space:]]*$';
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="opt_out_system_update_cache" returnType="trigger" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    IF (TG_OP = 'UPDATE') AND (NEW.last_evaluation IS NOT NULL OR NEW.advisor_evaluated IS NOT NULL) THEN
      -- system opted out
      IF OLD.opt_out = FALSE AND OLD.stale = FALSE AND (NEW.opt_out = TRUE OR NEW.stale = TRUE) THEN
        -- decrement affected cve counts for system
        WITH to_update_cves AS (
          SELECT cad.cve_id, cad.status_id AS global_status_id, sv.status_id
          FROM cve_account_data cad INNER JOIN
               system_vulnerabilities_active sv ON cad.cve_id = sv.cve_id LEFT OUTER JOIN
               insights_rule ir ON sv.rule_id = ir.id
          WHERE cad.rh_account_id = NEW.rh_account_id AND
                sv.system_id = NEW.id AND
                (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
                (sv.when_mitigated IS NULL OR ir.active = 'T')
          ORDER BY cad.cve_id, cad.status_id
          FOR UPDATE OF cad
        -- decrement systems_affected and systems_status_divergent in case status is different
        ), update_divergent AS (
          UPDATE cve_account_data cad
          SET systems_affected = systems_affected - 1,
              systems_status_divergent = systems_status_divergent - 1
          FROM to_update_cves
          WHERE cad.cve_id = to_update_cves.cve_id AND
                cad.rh_account_id = NEW.rh_account_id AND
                to_update_cves.global_status_id != to_update_cves.status_id
        )
        -- decrement only systems_affected in case status is same
        UPDATE cve_account_data cad
        SET systems_affected = systems_affected - 1
        FROM to_update_cves
        WHERE cad.cve_id = to_update_cves.cve_id AND
              cad.rh_account_id = NEW.rh_account_id AND
              to_update_cves.global_status_id = to_update_cves.status_id;
        -- delete zero cve counts
        DELETE FROM cve_account_data
        WHERE rh_account_id = NEW.rh_account_id AND
              systems_affected = 0;

      -- system opted in
      ELSIF (OLD.opt_out = TRUE OR OLD.stale = TRUE) AND NEW.opt_out = FALSE AND NEW.stale = FALSE THEN
        -- increment affected cve counts for system
        WITH to_update_cves AS (
          SELECT cad.cve_id, cad.status_id AS global_status_id, sv.status_id
          FROM cve_account_data cad INNER JOIN
               system_vulnerabilities_active sv ON cad.cve_id = sv.cve_id LEFT OUTER JOIN
               insights_rule ir ON sv.rule_id = ir.id
          WHERE cad.rh_account_id = NEW.rh_account_id AND
                sv.system_id = NEW.id AND
                (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
                (sv.when_mitigated IS NULL OR ir.active = 'T')
          ORDER BY cad.cve_id, cad.status_id
          FOR UPDATE OF cad
        -- increment systems_affected and systems_status_divergent in case status is different
        ), update_divergent AS (
          UPDATE cve_account_data cad
          SET systems_affected = systems_affected + 1,
              systems_status_divergent = systems_status_divergent + 1
          FROM to_update_cves
          WHERE cad.cve_id = to_update_cves.cve_id AND
                cad.rh_account_id = NEW.rh_account_id AND
                to_update_cves.global_status_id != to_update_cves.status_id
        )
        -- increment only systems_affected in case status is same
        UPDATE cve_account_data cad
        SET systems_affected = systems_affected + 1
        FROM to_update_cves
        WHERE cad.cve_id = to_update_cves.cve_id AND
              cad.rh_account_id = NEW.rh_account_id AND
              to_update_cves.global_status_id = to_update_cves.status_id;
        -- insert cache if not exists
        INSERT INTO cve_account_data (cve_id, rh_account_id, systems_affected)
        SELECT sv.cve_id, NEW.rh_account_id, 1
        FROM system_vulnerabilities_active sv LEFT OUTER JOIN
             insights_rule ir ON sv.rule_id = ir.id
        WHERE sv.system_id = NEW.id AND
              (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
              (sv.when_mitigated IS NULL OR ir.active = 'T') AND
              NOT EXISTS (
                SELECT 1 FROM cve_account_data
                WHERE rh_account_id = NEW.rh_account_id AND
                      cve_id = sv.cve_id
              )
        ON CONFLICT (cve_id, rh_account_id) DO UPDATE SET
          systems_affected = cve_account_data.systems_affected + EXCLUDED.systems_affected;
      END IF;
    END IF;
    RETURN NEW;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="refresh_account_cached_counts" returnType="void" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  DECLARE
    rh_account_id_in INT;
  BEGIN
    -- update cve count for ordered systems
    SELECT id FROM rh_account WHERE name = rh_account_in INTO rh_account_id_in;
    WITH to_update_systems AS (
      SELECT sp.id
      FROM system_platform sp
      WHERE sp.rh_account_id = rh_account_id_in
      ORDER BY sp.id
      FOR UPDATE OF sp
    )
    UPDATE system_platform sp SET cve_count_cache = (
      SELECT COUNT(cve_id) FROM system_vulnerabilities_active sv LEFT OUTER JOIN
                                insights_rule ir ON sv.rule_id = ir.id
      WHERE sv.system_id = sp.id AND (sv.mitigation_reason IS NULL OR ir.active = 'F') AND (sv.when_mitigated IS NULL OR ir.active = 'T')
    )
    FROM to_update_systems
    WHERE sp.id = to_update_systems.id;

    -- update system count for ordered cves
    WITH locked_rows AS (
      SELECT cad.cve_id
      FROM cve_account_data cad
      WHERE cad.rh_account_id = rh_account_id_in
      ORDER BY cad.cve_id
      FOR UPDATE OF cad
    ), current_counts AS (
      SELECT sv.cve_id, count(sv.system_id) as systems_affected
      FROM system_vulnerabilities_active sv INNER JOIN
           system_platform sp ON sv.system_id = sp.id LEFT OUTER JOIN
           insights_rule ir ON sv.rule_id = ir.id
      WHERE sp.when_deleted IS NULL AND
            (sp.last_evaluation IS NOT NULL OR sp.advisor_evaluated IS NOT NULL) AND
            (sp.opt_out = FALSE AND sp.stale = FALSE) AND
            (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
            (sv.when_mitigated IS NULL OR
            ir.active = 'T') AND
            sp.rh_account_id = rh_account_id_in
      GROUP BY sv.cve_id
    ), upserted AS (
      INSERT INTO cve_account_data (cve_id, rh_account_id, systems_affected)
        SELECT cve_id, rh_account_id_in, systems_affected FROM current_counts
      ON CONFLICT (cve_id, rh_account_id) DO UPDATE SET
        systems_affected = EXCLUDED.systems_affected
    )
    DELETE FROM cve_account_data WHERE cve_id NOT IN (SELECT cve_id FROM current_counts)
      AND rh_account_id = rh_account_id_in;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="refresh_all_cached_counts" returnType="void" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    -- update cve count for ordered systems
    WITH to_update_systems AS (
      SELECT sp.id
      FROM system_platform sp
      ORDER BY sp.rh_account_id, sp.id
      FOR UPDATE OF sp
    )
    UPDATE system_platform sp SET cve_count_cache = (
      SELECT COUNT(cve_id) FROM system_vulnerabilities_active sv LEFT OUTER JOIN
                                insights_rule ir ON sv.rule_id = ir.id
      WHERE sv.system_id = sp.id AND (sv.mitigation_reason IS NULL OR ir.active = 'F') AND (sv.when_mitigated IS NULL OR ir.active = 'T')
    )
    FROM to_update_systems
    WHERE sp.id = to_update_systems.id;

    -- update system count for ordered cves
    WITH locked_rows AS (
      SELECT cad.rh_account_id, cad.cve_id
      FROM cve_account_data cad
      ORDER BY cad.rh_account_id, cad.cve_id
      FOR UPDATE OF cad
    ), current_counts AS (
      SELECT sv.cve_id, sp.rh_account_id, count(sv.system_id) as systems_affected
      FROM system_vulnerabilities_active sv INNER JOIN
           system_platform sp ON sv.system_id = sp.id LEFT OUTER JOIN
           insights_rule ir ON sv.rule_id = ir.id
      WHERE sp.when_deleted IS NULL AND
            (sp.last_evaluation IS NOT NULL OR sp.advisor_evaluated IS NOT NULL) AND
            (sp.opt_out = FALSE AND sp.stale = FALSE) AND
            (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
            (sv.when_mitigated IS NULL OR
            ir.active = 'T')
      GROUP BY sv.cve_id, sp.rh_account_id
    ), upserted AS (
      INSERT INTO cve_account_data (cve_id, rh_account_id, systems_affected)
        SELECT cve_id, rh_account_id, systems_affected FROM current_counts
      ON CONFLICT (cve_id, rh_account_id) DO UPDATE SET
        systems_affected = EXCLUDED.systems_affected
    )
    DELETE FROM cve_account_data WHERE (cve_id, rh_account_id) NOT IN (SELECT cve_id, rh_account_id FROM current_counts);
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="refresh_cve_account_cached_counts" returnType="void" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  DECLARE
    cve_md_id INT;
    rh_account_id_in INT;
  BEGIN
    -- update system count for ordered cves
    SELECT id FROM cve_metadata WHERE cve = cve_in INTO cve_md_id;
    SELECT id FROM rh_account WHERE name = rh_account_in INTO rh_account_id_in;
    WITH locked_rows AS (
      SELECT cad.rh_account_id, cad.cve_id
      FROM cve_account_data cad
      WHERE cad.cve_id = cve_md_id AND
            cad.rh_account_id = rh_account_id_in
      ORDER BY cad.rh_account_id, cad.cve_id
      FOR UPDATE OF cad
    ), current_counts AS (
      SELECT sv.cve_id, sp.rh_account_id, count(sv.system_id) as systems_affected
      FROM system_vulnerabilities_active sv INNER JOIN
           system_platform sp ON sv.system_id = sp.id LEFT OUTER JOIN
           insights_rule ir ON sv.rule_id = ir.id
      WHERE sp.when_deleted IS NULL AND
            (sp.last_evaluation IS NOT NULL OR sp.advisor_evaluated IS NOT NULL) AND
            (sp.opt_out = FALSE AND sp.stale = FALSE) AND
            (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
            (sv.when_mitigated IS NULL OR
            ir.active = 'T') AND
            sv.cve_id = cve_md_id AND
            sp.rh_account_id = rh_account_id_in
      GROUP BY sv.cve_id, sp.rh_account_id
    ), upserted AS (
      INSERT INTO cve_account_data (cve_id, rh_account_id, systems_affected)
        SELECT cve_md_id, rh_account_id_in, systems_affected FROM current_counts
      ON CONFLICT (cve_id, rh_account_id) DO UPDATE SET
        systems_affected = EXCLUDED.systems_affected
    )
    DELETE FROM cve_account_data WHERE NOT EXISTS (SELECT 1 FROM current_counts)
      AND cve_id = cve_md_id
      AND rh_account_id = rh_account_id_in;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="refresh_cve_cached_counts" returnType="void" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  DECLARE
    cve_md_id INT;
  BEGIN
    -- update system count for cve
    SELECT id FROM cve_metadata WHERE cve = cve_in INTO cve_md_id;
    WITH locked_rows AS (
      SELECT cad.rh_account_id
      FROM cve_account_data cad
      WHERE cad.cve_id = cve_md_id
      ORDER BY cad.rh_account_id
      FOR UPDATE OF cad
    ), current_counts AS (
      SELECT sp.rh_account_id, count(sv.system_id) as systems_affected
      FROM system_vulnerabilities_active sv INNER JOIN
           system_platform sp ON sv.system_id = sp.id LEFT OUTER JOIN
           insights_rule ir ON sv.rule_id = ir.id
      WHERE sp.when_deleted IS NULL AND
            (sp.last_evaluation IS NOT NULL OR sp.advisor_evaluated IS NOT NULL) AND
            (sp.opt_out = FALSE AND sp.stale = FALSE) AND
            (sv.mitigation_reason IS NULL OR ir.active = 'F') AND
            (sv.when_mitigated IS NULL OR
            ir.active = 'T') AND
            sv.cve_id = cve_md_id
      GROUP BY sp.rh_account_id
    ), upserted AS (
      INSERT INTO cve_account_data (cve_id, rh_account_id, systems_affected)
        SELECT cve_md_id, rh_account_id, systems_affected FROM current_counts
      ON CONFLICT (cve_id, rh_account_id) DO UPDATE SET
        systems_affected = EXCLUDED.systems_affected
    )
    DELETE FROM cve_account_data WHERE rh_account_id NOT IN (SELECT rh_account_id FROM current_counts)
      AND cve_id = cve_md_id;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="refresh_system_cached_counts" returnType="void" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    -- update cve count for system
    UPDATE system_platform sp SET cve_count_cache = (
      SELECT COUNT(cve_id) FROM system_vulnerabilities_active sv LEFT OUTER JOIN
                                insights_rule ir ON sv.rule_id = ir.id
      WHERE sv.system_id = sp.id AND (sv.mitigation_reason IS NULL OR ir.active = 'F') AND (sv.when_mitigated IS NULL OR ir.active = 'T')
    ) WHERE sp.inventory_id = inventory_id_in;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="set_first_reported" returnType="trigger" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    IF NEW.first_reported IS NULL THEN
      NEW.first_reported := CURRENT_TIMESTAMP;
    END IF;
    RETURN NEW;
  END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="set_last_updated" returnType="trigger" securityType="INVOKER" type="FUNCTION">
         <comment/>
         <definition language="PLPGSQL"><![CDATA[
  BEGIN
    IF (TG_OP = 'UPDATE') OR
       NEW.last_updated IS NULL THEN
      NEW.last_updated := CURRENT_TIMESTAMP;
    END IF;
    RETURN NEW;
  END;
]]></definition>
      </routine>
   </routines>
</database>
